<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Refactoring Autenticazione</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { padding: 2rem; font-family: sans-serif; }
        .test-case { border: 1px solid #eee; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; }
        .test-title { font-weight: bold; margin-bottom: 0.5rem; }
        .test-status { font-weight: bold; }
        .pass { color: green; }
        .fail { color: red; }
        .info { color: blue; }
        #auth-container { margin-top: 1rem; padding: 1rem; border: 1px dashed #ccc; }
    </style>
</head>
<body>
    <h1>Test del Sistema di Autenticazione (Post-Refactoring)</h1>
    <p>Questa pagina testa le funzionalità di login/logout dopo il refactoring del codice di autenticazione.</p>
    
    <div id="auth-container">
        <!-- L'UI di autenticazione verrà renderizzata qui -->
    </div>

    <hr>

    <div id="test-results">
        <h2>Risultati dei Test</h2>
        <!-- I risultati dei test verranno aggiunti qui -->
    </div>

    <script type="module">
        // Usa percorsi assoluti dalla root del progetto
        import { supabase } from '/src/js/supabase.js';
        import { initAuth, signOut, enableDevelopmentBypass, checkDevelopmentBypass, clearDevelopmentBypass } from '/src/js/auth.js';

        window.supabase = supabase; // Esponi globalmente per il test

        const resultsContainer = document.getElementById('test-results');

        function logTest(title, passed, message = '') {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-case';
            const statusClass = passed ? 'pass' : 'fail';
            const statusText = passed ? 'PASSATO' : 'FALLITO';
            
            resultDiv.innerHTML = `
                <div class="test-title">${title}</div>
                <div class="test-status ${statusClass}">${statusText}</div>
                ${message ? `<p class="info">${message}</p>` : ''}
            `;
            resultsContainer.appendChild(resultDiv);
            return passed;
        }

        async function runTests() {
            // Test 1: La UI iniziale è corretta (stato non autenticato)
            logTest(
                'Test 1: UI Iniziale',
                document.getElementById('login-modal-trigger') !== null,
                'Verifica che il pulsante "Accedi" sia visibile.'
            );

            // Test 2: Apertura del modale
            document.getElementById('login-modal-trigger').click();
            await new Promise(r => setTimeout(r, 500)); // Attendi l'animazione del modale
            const modal = document.getElementById('auth-modal');
            logTest(
                'Test 2: Apertura Modale di Login',
                modal !== null && modal.classList.contains('show'),
                'Cliccando su "Accedi", il modale dovrebbe apparire.'
            );
            if (modal) {
                 bootstrap.Modal.getInstance(modal).hide();
            }

            // Test 3: Logout (preventivo)
            await signOut();
            logTest(
                'Test 3: Logout Preventivo',
                document.getElementById('login-modal-trigger') !== null,
                'Assicura di essere disconnesso prima dei test di login.'
            );

            // Test 4: Bypass di sviluppo
            if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
                clearDevelopmentBypass();
                const bypassSession = enableDevelopmentBypass();
                const checkedSession = checkDevelopmentBypass();
                logTest(
                    'Test 4: Bypass di Sviluppo',
                    bypassSession !== null && checkedSession !== null && bypassSession.user.id === checkedSession.user.id,
                    'Il bypass di sviluppo dovrebbe creare e verificare una sessione fittizia.'
                );
                clearDevelopmentBypass();
            } else {
                 logTest(
                    'Test 4: Bypass di Sviluppo',
                    true,
                    'Test saltato (non in ambiente di sviluppo).'
                );
            }
             
            console.log("Test completati. Per testare il login con Email e Google, è richiesta un'azione manuale nel modale.");
            logTest(
                'Test Manuali Richiesti',
                true,
                'Per favore, testa manualmente il login con Email e Google tramite il pulsante "Accedi" qui sopra. Verifica anche il logout.'
            );
        }

        // Inizializza il sistema di autenticazione e avvia i test
        initAuth((session) => {
            console.log('Stato di autenticazione cambiato:', session);
        });

        // Avvia i test dopo un breve ritardo per consentire l'inizializzazione
        setTimeout(runTests, 1000);
    </script>
    
    <!-- Dipendenze -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
